---
title: "Climate Scenarios Report for Area of Interest"
output:
  html_document:
    css: style.css
  word_document: default
params:
  area_name: "Default Area"
  plot_data: NULL
  aoi_params: NULL
  aoi_scenarios: NULL
  params_def: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, dpi = 300, fig.retina = 2)
library(ggplot2)
library(dplyr)
```
# Report for `r params$area_name`

This report shows the annual time series plots for various climate parameters and scenarios for the selected area of interest.

```{r generate_plots, echo=FALSE, results='asis', warning=FALSE, message=FALSE, dpi=400}
if (is.null(params$aoi_params) || nrow(params$aoi_params) == 0) {
  knitr::asis_output(
    "<p><em>No climate parameters were selected for this report.</em></p>"
  )
} else {
  # Loop through each parameter (e.g., Temperature, Precipitation)
  for (i in seq_len(nrow(params$aoi_params))) {
    param_code <- params$aoi_params$param[i]
    param_name <- params$aoi_params$name[i]

    # --- Data Aggregation for Faceting ---
    all_scenarios_data <- lapply(params$aoi_scenarios, function(scen_code) {
      plot_id <- paste(param_code, scen_code, sep = "_")
      df <- params$plot_data[[plot_id]]
      
      if (is.data.frame(df) && nrow(df) > 0 && !all(is.na(df$value))) {
        df$scenario <- toupper(scen_code)
        return(df)
      }
      return(NULL)
    })
    
    combined_df <- dplyr::bind_rows(all_scenarios_data)

    # --- Header and Plot Generation ---

    # 1. Print the parameter name as a header FIRST.
    # This is the key change: separating the header output from the plot output.
    cat(paste0("<h4>", param_name, "</h4>"))

    # 2. Now, proceed to generate either the plot or the "no data" message.
    if (is.data.frame(combined_df) && nrow(combined_df) > 0) {
      
      param_info <- dplyr::filter(params$params_def, input == param_code)
      y_label <- param_name # Fallback to param_name
      if (nrow(param_info) > 0 && "unit" %in% colnames(param_info)) {
        unit <- param_info$unit
        if (is.character(unit) && !is.na(unit) && nzchar(trimws(unit))) {
          y_label <- unit
        }
      }
      
      if ("date" %in% colnames(combined_df)) {
        combined_df <- combined_df %>%
          mutate(date = as.numeric(format(as.Date(date), "%Y")))
      }

      # Create the ggplot object
      line_color <- if (param_code %in% c("pr", "csdi")) "steelblue" else "red"
      p <- ggplot(combined_df, aes(x = date)) + 
        geom_ribbon(aes(ymin = value10, ymax = value90), fill = "grey70", alpha = 0.5) + 
        geom_line(aes(y = value), color = line_color) + 
        geom_smooth(aes(y = value), method = "lm", se = FALSE, color = "#252525", linewidth = 0.25) + 
        facet_wrap(~scenario, ncol = 2) + 
        scale_x_continuous(breaks = c(1961, 1981,2000, 2014, 2021, 2041,2061, 2081, 2100)) + 
        labs(
          x = "Year",
          y = y_label
        ) + 
        theme_minimal(base_size = 10) + 
        theme(
          strip.text = element_text(size = 10),
          axis.title = element_text(size = 10),
          axis.text = element_text(size = 9),
          axis.text.x = element_text(angle = 45, hjust = 1)
        )
      
      # Print the combined plot
      print(p)

    } else {
      # Fallback message if no data exists for this parameter
      # The header is already printed above, so we only need the message here.
      knitr::asis_output(
        paste0("<p><em>Data not available for this parameter.</em></p>")
      )
    }

    # Add a horizontal rule between parameter sections
    if (i < nrow(params$aoi_params)) {
      knitr::asis_output("\n<hr/>\n\n")
    }
  }
}
```